# Fluent Bit Configuration for LogWard
# Receives syslog and system logs, forwards to LogWard API

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File /fluent-bit/etc/parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

# =============================================================================
# INPUT - System logs (Linux /var/log)
# =============================================================================
[INPUT]
    Name         tail
    Tag          host.syslog
    Path         /var/log/syslog,/var/log/messages
    Parser       syslog-rfc3164
    Refresh_Interval 5
    Skip_Long_Lines On

[INPUT]
    Name         tail
    Tag          host.auth
    Path         /var/log/auth.log,/var/log/secure
    Parser       syslog-rfc3164
    Refresh_Interval 5
    Skip_Long_Lines On

# =============================================================================
# INPUT - Syslog UDP (standard port 514 mapped to 5140)
# =============================================================================
[INPUT]
    Name         syslog
    Tag          syslog.udp
    Mode         udp
    Listen       0.0.0.0
    Port         5140
    Parser       syslog-rfc3164
    Buffer_Chunk_Size 32k
    Buffer_Max_Size   64k

# =============================================================================
# INPUT - Syslog TCP (standard port 514 mapped to 5140)
# =============================================================================
[INPUT]
    Name         syslog
    Tag          syslog.tcp
    Mode         tcp
    Listen       0.0.0.0
    Port         5140
    Parser       syslog-rfc3164
    Buffer_Chunk_Size 32k
    Buffer_Max_Size   64k

# =============================================================================
# FILTER - Transform to LogWard format
# =============================================================================
[FILTER]
    Name         lua
    Match        *
    Script       /fluent-bit/etc/syslog_transform.lua
    Call         transform_syslog

# =============================================================================
# OUTPUT - Send to LogWard API
# =============================================================================
[OUTPUT]
    Name         http
    Match        *
    Host         logward-backend
    Port         8080
    URI          /api/v1/ingest/single
    Format       json
    Header       X-API-Key ${LOGWARD_API_KEY}
    Header       Content-Type application/json
    Json_date_key time
    Json_date_format iso8601
    Retry_Limit  3
    tls          Off

# =============================================================================
# OUTPUT - Debug (uncomment to see logs in console)
# =============================================================================
# [OUTPUT]
#     Name         stdout
#     Match        *
#     Format       json_lines
